<!DOCTYPE html>
<html>
<head>
  <title>Boston Hospital Finder</title>
  <meta charset="UTF-8">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }

    #header {
      background: #003087; color: white;
      padding: 16px 24px;
    }
    #header h1 { font-size: 22px; }
    #header p  { font-size: 13px; opacity: 0.8; margin-top: 4px; }

    #controls {
      background: white; padding: 14px 24px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      border-bottom: 1px solid #ddd;
    }
    input, select, button {
      padding: 8px 12px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    button { background: #003087; color: white; border: none; cursor: pointer; }
    button:hover { background: #00205b; }

    #main { display: flex; height: calc(100vh - 110px); }

    #map { flex: 1; height: 100%; }

    #sidebar {
      width: 320px;
      background: white;
      border-left: 1px solid #ddd;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #sidebar-header {
      padding: 12px 16px; background: #f9f9f9;
      border-bottom: 1px solid #ddd; font-size: 13px; color: #555;
    }
    #results { overflow-y: auto; flex: 1; padding: 10px; }
    #loading {
      display: none; padding: 20px;
      text-align: center; color: #555; font-size: 14px;
    }

    .hospital-card {
      border: 1px solid #ddd; border-radius: 6px;
      padding: 10px 12px; margin-bottom: 8px;
      cursor: pointer; transition: border-color 0.2s;
    }
    .hospital-card:hover { border-color: #003087; }
    .hospital-card.active { border-color: #003087; background: #f0f4ff; }
    .hospital-name { font-weight: bold; font-size: 14px; }
    .hospital-meta { font-size: 12px; color: #666; margin-top: 3px; }
    .dist-badge {
      display: inline-block; background: #003087; color: white;
      border-radius: 10px; padding: 1px 8px; font-size: 11px; margin-left: 6px;
    }

    .popup-table {
      font-size: 12px;
      margin-top: 6px;
      border-collapse: collapse;
      width: 100%;
    }
    .popup-table td {
      padding: 3px 4px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>üè• Boston Hospital Finder</h1>
  <p>Find nearby hospitals and explore neighborhood vulnerability across Boston</p>
</div>

<div id="controls">
  <input type="text" id="zip" placeholder="Enter ZIP code (e.g. 02115)" maxlength="5" style="width:220px">
  <select id="radius">
    <option value="1">Within 1 mile</option>
    <option value="5" selected>Within 5 miles</option>
    <option value="10">Within 10 miles</option>
    <option value="25">Within 25 miles</option>
  </select>
  <button onclick="findHospitals()">Search</button>
</div>

<div id="main">
  <div id="map"></div>
  <div id="sidebar">
    <div id="sidebar-header">Enter a ZIP code to find nearby hospitals</div>
    <div id="loading">‚è≥ Loading data...</div>
    <div id="results"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
// ‚îÄ‚îÄ Data URLs ‚îÄ‚îÄ
const HOSPITAL_CSV = "https://data.boston.gov/dataset/d9871e89-2d1e-4ecf-b0de-046f553027c0/resource/6222085d-ee88-45c6-ae40-0c7464620d64/download/hospital-locations.csv";

const VULN_CSV = "https://data.boston.gov/dataset/climate-ready-boston-social-vulnerability/resource/3cfa5c04-8b2d-49b6-9c53-5f7fa693596e/download/climate-ready-boston-social-vulnerability.csv";

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let map;
let markersLayer;
let vulnByNeigh = {};

// ‚îÄ‚îÄ Initialize Map ‚îÄ‚îÄ
function initMap() {
  map = L.map("map").setView([42.3601, -71.0589], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
}

// ‚îÄ‚îÄ CSV parser ‚îÄ‚îÄ
function parseCSV(text) {
  const rows = text.trim().split("\n");
  const headers = rows[0].split(",");
  return rows.slice(1).map(r => {
    const vals = r.split(",");
    const obj = {};
    headers.forEach((h,i) => obj[h.trim().toUpperCase()] = vals[i]);
    return obj;
  });
}

// ‚îÄ‚îÄ Vulnerability Loader ‚îÄ‚îÄ
async function loadVulnerability() {
  const text = await fetch(VULN_CSV).then(r => r.text());
  const rows = parseCSV(text);

  const grouped = {};

  rows.forEach(r => {
    const name = (r["NAME"] || "").toUpperCase().trim();
    if (!name) return;

    if (!grouped[name]) {
      grouped[name] = {
        pop: 0,
        elderly: 0,
        dis: 0,
        lep: 0
      };
    }

    grouped[name].pop += parseFloat(r["POP100_RE"]) || 0;
    grouped[name].elderly += parseFloat(r["OLDERADULT"]) || 0;
    grouped[name].dis += parseFloat(r["TOTDIS"]) || 0;
    grouped[name].lep += parseFloat(r["LEP"]) || 0;
  });

  Object.keys(grouped).forEach(name => {
    const g = grouped[name];
    if (g.pop > 0) {
      vulnByNeigh[name] = {
        elderly: (g.elderly / g.pop) * 100,
        disabilities: (g.dis / g.pop) * 100,
        limitedEnglish: (g.lep / g.pop) * 100
      };
    }
  });
}

// ‚îÄ‚îÄ Distance helper ‚îÄ‚îÄ
function distMiles(lat1, lon1, lat2, lon2) {
  const dLat = (lat2 - lat1) * 69;
  const dLon = (lon2 - lon1) * 52;
  return Math.sqrt(dLat * dLat + dLon * dLon);
}

// ‚îÄ‚îÄ ZIP lookup ‚îÄ‚îÄ
async function getZipCoords(zip) {
  const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
  if (!res.ok) return null;
  const d = await res.json();
  return {
    lat: parseFloat(d.places[0].latitude),
    lon: parseFloat(d.places[0].longitude)
  };
}

// ‚îÄ‚îÄ Marker ‚îÄ‚îÄ
function makeMarker(lat, lon) {
  return L.circleMarker([lat, lon], {
    radius: 10,
    fillColor: "#007BFF",
    color: "#ffffff",
    weight: 2,
    fillOpacity: 0.9
  });
}

// ‚îÄ‚îÄ Popup Builder ‚îÄ‚îÄ
function makePopupHTML(hospital, vuln) {
  if (!vuln) return `<b>${hospital.NAME}</b><br>${hospital.AD || ""}`;

  return `
    <b>${hospital.NAME}</b><br>
    ${hospital.AD || ""}

    <table class="popup-table">
      <tr><td>Elderly (65+)</td><td>${vuln.elderly.toFixed(1)}%</td></tr>
      <tr><td>Disabilities</td><td>${vuln.disabilities.toFixed(1)}%</td></tr>
      <tr><td>Limited English</td><td>${vuln.limitedEnglish.toFixed(1)}%</td></tr>
    </table>
  `;
}

// ‚îÄ‚îÄ Main Search ‚îÄ‚îÄ
async function findHospitals() {
  const zipInput = document.getElementById("zip").value.trim();
  const radius   = parseFloat(document.getElementById("radius").value);
  const resultsDiv = document.getElementById("results");
  const loading = document.getElementById("loading");
  const sidebarHdr = document.getElementById("sidebar-header");

  if (!zipInput || zipInput.length < 5) {
    resultsDiv.innerHTML = "<p style='padding:16px;color:#666'>Please enter a valid ZIP.</p>";
    return;
  }

  loading.style.display = "block";
  resultsDiv.innerHTML = "";
  markersLayer.clearLayers();

  const [coords, hospText] = await Promise.all([
    getZipCoords(zipInput),
    fetch(HOSPITAL_CSV).then(r => r.text()),
    loadVulnerability()
  ]);

  if (!coords) {
    loading.style.display = "none";
    resultsDiv.innerHTML = "<p style='padding:16px;color:red'>ZIP not found.</p>";
    return;
  }

  const hospitals = parseCSV(hospText);
  const coordRx = /\(\s*([-\d.]+),\s*([-\d.]+)\s*\)/;

  const matches = hospitals.map(h => {
    const m = (h["LOCATION"] || "").match(coordRx);
    if (!m) return null;
    const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
    return { ...h, lat, lon, dist: distMiles(coords.lat, coords.lon, lat, lon) };
  }).filter(h => h && h.dist <= radius)
    .sort((a, b) => a.dist - b.dist);

  loading.style.display = "none";

  if (!matches.length) {
    sidebarHdr.textContent = `No hospitals within ${radius} miles`;
    return;
  }

  sidebarHdr.textContent =
    `${matches.length} hospital${matches.length > 1 ? "s" : ""} within ${radius} miles`;

  const markers = [];

  matches.forEach(h => {
    const neighKey = (h.NEIGH || "").toUpperCase().trim();
    const vuln = vulnByNeigh[neighKey];

    const marker = makeMarker(h.lat, h.lon)
      .addTo(markersLayer)
      .bindPopup(makePopupHTML(h, vuln));

    markers.push(marker);
  });

  if (markers.length) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  renderSidebar(matches, markers);
}

// ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
function renderSidebar(matches, markers) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  matches.forEach((h, idx) => {
    const card = document.createElement("div");
    card.className = "hospital-card";
    card.innerHTML = `
      <div class="hospital-name">
        ${h.NAME}
        <span class="dist-badge">${h.dist.toFixed(1)} mi</span>
      </div>
      <div class="hospital-meta">üìç ${h.AD || ""}</div>
    `;

    card.onclick = () => {
      document.querySelectorAll(".hospital-card").forEach(c => c.classList.remove("active"));
      card.classList.add("active");
      map.panTo([h.lat, h.lon]);
      markers[idx].openPopup();
    };

    resultsDiv.appendChild(card);
  });
}

document.getElementById("zip").addEventListener("keydown", e => {
  if (e.key === "Enter") findHospitals();
});

initMap();
</script>
</body>
</html>